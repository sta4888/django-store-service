{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-tools me-2"></i>Админ-панель API</h1>
        <div class="badge bg-info">API Endpoint: {{ FASTAPI_SERVICE_URL }}</div>
    </div>

    <!-- Табы -->
    <ul class="nav nav-tabs mb-4" id="apiTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="add-lo-tab" data-bs-toggle="tab" data-bs-target="#add-lo" type="button">
                <i class="fas fa-plus-circle me-2"></i>Добавить LO
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sub-lo-tab" data-bs-toggle="tab" data-bs-target="#sub-lo" type="button">
                <i class="fas fa-minus-circle me-2"></i>Вычесть LO
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure" type="button">
                <i class="fas fa-sitemap me-2"></i>Структура пользователя
            </button>
        </li>
    </ul>

    <!-- Содержимое табов -->
    <div class="tab-content" id="apiTabsContent">

        <!-- Таб: Добавить LO -->
        <div class="tab-pane fade show active" id="add-lo" role="tabpanel">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Добавить Личный Объем (LO)</h5>
                </div>
                <div class="card-body">
                    <form id="addLoForm">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">ID пользователя</label>
                                <input type="text" class="form-control" name="user_id"
                                       placeholder="Например: 00000008" required>
                                <div class="form-text">Введите ID пользователя</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Сумма LO</label>
                                <input type="number" class="form-control" name="lo"
                                       placeholder="Введите сумму" step="0.01" min="0.01" required>
                                <div class="form-text">Сумма для добавления</div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-plus me-2"></i>Добавить LO
                        </button>
                    </form>

                    <div class="mt-4" id="addLoResult">
                        <!-- Здесь будет результат -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Таб: Вычесть LO -->
        <div class="tab-pane fade" id="sub-lo" role="tabpanel">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-minus-circle me-2"></i>Вычесть Личный Объем (LO)</h5>
                </div>
                <div class="card-body">
                    <form id="subtractLoForm">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">ID пользователя</label>
                                <input type="text" class="form-control" name="user_id"
                                       placeholder="Например: 00000008" required>
                                <div class="form-text">Введите ID пользователя</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Сумма LO</label>
                                <input type="number" class="form-control" name="lo"
                                       placeholder="Введите сумму" step="0.01" min="0.01" required>
                                <div class="form-text">Сумма для вычитания</div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-danger btn-lg">
                            <i class="fas fa-minus me-2"></i>Вычесть LO
                        </button>
                    </form>

                    <div class="mt-4" id="subtractLoResult">
                        <!-- Здесь будет результат -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Таб: Структура -->
        <div class="tab-pane fade" id="structure" role="tabpanel">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-sitemap me-2"></i>Структура пользователя</h5>
                </div>
                <div class="card-body">
                    <form id="getStructureForm" class="mb-4">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-8">
                                <label class="form-label">ID пользователя</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="user_id"
                                           placeholder="Например: 00000006" required>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search me-2"></i>Получить структуру
                                    </button>
                                </div>
                                <div class="form-text">Введите ID пользователя для просмотра его структуры</div>
                            </div>
                        </div>
                    </form>

                    <div id="structureResult">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Введите ID пользователя и нажмите "Получить структуру"
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.nav-tabs .nav-link {
    font-weight: 500;
    font-size: 1.1rem;
}

.nav-tabs .nav-link.active {
    border-color: var(--color-red) var(--color-red) #fff;
    border-bottom: 3px solid var(--color-red);
    color: var(--color-red);
    font-weight: 600;
}

.form-control:focus {
    border-color: var(--color-red);
    box-shadow: 0 0 0 0.25rem rgba(229, 57, 53, 0.25);
}

.tree-structure {
    max-height: 600px;
    overflow-y: auto;
    padding: 15px;
    background: var(--color-light);
    border-radius: 8px;
}

.tree {
    list-style: none;
    padding-left: 0;
}

.tree ul {
    padding-left: 25px;
    border-left: 2px dashed var(--color-gray-300);
    margin-left: 15px;
}

.tree li {
    margin: 12px 0;
    position: relative;
}

.tree-node {
    padding: 10px 15px;
    background: white;
    border: 1px solid var(--color-gray-200);
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.tree-node:hover {
    border-color: var(--color-red);
    box-shadow: 0 4px 8px rgba(229, 57, 53, 0.1);
}

.node-main {
    font-weight: 500;
    color: var(--color-gray-800);
}

.node-lo {
    background: var(--color-red-soft);
    color: var(--color-red);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
}

.user-level-1 { margin-left: 0; }
.user-level-2 { margin-left: 20px; }
.user-level-3 { margin-left: 40px; }
.user-level-4 { margin-left: 60px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Форма добавления LO
    document.getElementById('addLoForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const userId = formData.get('user_id');
        const loAmount = formData.get('lo');

        const resultDiv = document.getElementById('addLoResult');
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Добавление ${loAmount} LO пользователю ${userId}...
            </div>
        `;

        try {
            const response = await fetch(`/api/admin/lo/add/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ lo: parseFloat(loAmount) })
            });

            const data = await response.json();

            if (response.ok) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Успешно добавлено ${loAmount} LO пользователю ${userId}
                    </div>
                    <div class="card mt-3">
                        <div class="card-body">
                            <pre class="mb-0">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Ошибка: ${data.error || 'Неизвестная ошибка'}
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    Ошибка сети: ${error.message}
                </div>
            `;
        }
    });

    // Форма вычитания LO
    document.getElementById('subtractLoForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const userId = formData.get('user_id');
        const loAmount = formData.get('lo');

        if (!confirm(`Вы уверены, что хотите вычесть ${loAmount} LO у пользователя ${userId}?`)) {
            return;
        }

        const resultDiv = document.getElementById('subtractLoResult');
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Вычитание ${loAmount} LO у пользователя ${userId}...
            </div>
        `;

        try {
            const response = await fetch(`/api/admin/lo/subtract/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ lo: parseFloat(loAmount) })
            });

            const data = await response.json();

            if (response.ok) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Успешно вычтено ${loAmount} LO у пользователя ${userId}
                    </div>
                    <div class="card mt-3">
                        <div class="card-body">
                            <pre class="mb-0">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Ошибка: ${data.error || 'Неизвестная ошибка'}
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    Ошибка сети: ${error.message}
                </div>
            `;
        }
    });

    // Форма получения структуры
    document.getElementById('getStructureForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const userId = formData.get('user_id');

        const resultDiv = document.getElementById('structureResult');
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Получение структуры пользователя ${userId}...
            </div>
        `;

        try {
            const response = await fetch(`/api/admin/structure/${userId}/`);
            const data = await response.json();

            if (response.ok) {
                // Рисуем дерево структуры
                resultDiv.innerHTML = buildTreeHTML(userId, data);
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Ошибка: ${data.error || 'Не удалось получить структуру'}
                    </div>
                `;
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    Ошибка сети: ${error.message}
                </div>
            `;
        }
    });
});

// Функция для построения дерева структуры
function buildTreeHTML(rootId, data) {
    if (!data.children || data.children.length === 0) {
        return `
            <div class="alert alert-warning">
                <i class="fas fa-users-slash me-2"></i>
                У пользователя ${rootId} нет рефералов в структуре
            </div>
        `;
    }

    let html = `
        <div class="tree-structure">
            <div class="tree">
                <li>
                    <div class="tree-node">
                        <span class="node-main">
                            <i class="fas fa-user-circle me-2"></i>
                            <strong>${rootId}</strong>
                            <span class="badge bg-primary ms-2">Корень</span>
                        </span>
                        ${data.lo ? `<span class="node-lo">LO: ${data.lo}</span>` : ''}
                    </div>
    `;

    // Рекурсивно строим дерево
    html += buildTreeChildren(data.children, 1);

    html += `
                </li>
            </div>
        </div>

        <div class="mt-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-muted small">Всего в структуре</div>
                            <div class="h3 mt-2">${countTotalChildren(data.children)}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-muted small">Прямых рефералов</div>
                            <div class="h3 mt-2">${data.children.length}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-muted small">Уровней</div>
                            <div class="h3 mt-2">${countLevels(data.children)}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    return html;
}

function buildTreeChildren(children, level) {
    if (!children || children.length === 0) return '';

    let html = '<ul>';
    children.forEach(child => {
        html += `
            <li class="user-level-${level}">
                <div class="tree-node">
                    <span class="node-main">
                        <i class="fas fa-user me-2"></i>
                        ${child.user_id}
                        <span class="badge bg-secondary ms-2">Уровень ${level}</span>
                    </span>
                    ${child.lo ? `<span class="node-lo">LO: ${child.lo}</span>` : ''}
                </div>
        `;

        if (child.children && child.children.length > 0) {
            html += buildTreeChildren(child.children, level + 1);
        }

        html += '</li>';
    });
    html += '</ul>';
    return html;
}

function countTotalChildren(children) {
    if (!children) return 0;
    let count = children.length;
    children.forEach(child => {
        if (child.children) {
            count += countTotalChildren(child.children);
        }
    });
    return count;
}

function countLevels(children) {
    if (!children || children.length === 0) return 0;
    let maxLevel = 0;
    children.forEach(child => {
        if (child.children && child.children.length > 0) {
            const childLevels = 1 + countLevels(child.children);
            if (childLevels > maxLevel) maxLevel = childLevels;
        } else {
            if (1 > maxLevel) maxLevel = 1;
        }
    });
    return maxLevel;
}
</script>
{% endblock %}