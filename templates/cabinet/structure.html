{% extends 'base.html' %}
{% load static %}


{% block title %}Моя структура | EVERON{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Боковое меню -->
        <div class="col-lg-3 mb-4">
            {% include 'includes/sidebar.html' %}
        </div>
        
        <!-- Основная информация -->
        <div class="col-lg-9">
            <!-- Заголовок и статистика -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-sitemap me-2"></i> Моя структура</h1>
                <div class="text-end">
                    <div class="text-muted small">ID партнера: {{ user.username }}</div>
                    <div class="text-muted small">Всего рефералов: {{ total_referrals }}</div>
                </div>
            </div>

            <!-- Статистика карточки -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Всего рефералов</div>
                            <div class="stat-value">{{ total_referrals }}</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-users fa-2x" style="color: var(--color-green);"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Активных рефералов</div>
                            <div class="stat-value">{{ active_referrals }}</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-user-check fa-2x" style="color: var(--color-blue);"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Групповой объем</div>
                            <div class="stat-value">{{ group_volume }} бал</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-line fa-2x" style="color: var(--color-orange);"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===================== ВКЛАДКИ ===================== -->
            <ul class="nav nav-tabs mb-0" id="structureTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="tab"
                            data-bs-target="#list-panel" type="button" role="tab"
                            aria-controls="list-panel" aria-selected="true">
                        <i class="fas fa-list me-1"></i> Список
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="graph-tab" data-bs-toggle="tab"
                            data-bs-target="#graph-panel" type="button" role="tab"
                            aria-controls="graph-panel" aria-selected="false"
                            id="graphTabBtn">
                        <i class="fas fa-project-diagram me-1"></i> Граф структуры
                    </button>
                </li>
            </ul>

            <div class="tab-content border border-top-0 rounded-bottom bg-white" id="structureTabContent">

                <!-- ========== ВКЛАДКА: СПИСОК ========== -->
                <div class="tab-pane fade show active p-0" id="list-panel" role="tabpanel">

                    <!-- Фильтры и поиск -->
                    <div class="card border-0 border-bottom rounded-0">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="filter-tabs mb-3 mb-md-0">
                                        <button class="btn btn-sm btn-outline-accent active" data-level="1">
                                            1-й уровень <span class="badge bg-accent ms-1">{{ direct_referrals.paginator.count }}</span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" data-level="2">
                                            2-й уровень
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" data-level="3">
                                            3-й уровень
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-sm" 
                                               id="searchReferrals" placeholder="Поиск...">
                                        <button class="btn btn-outline-secondary btn-sm" type="button">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Таблица рефералов -->
                    <div class="card border-0 rounded-0 rounded-bottom">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-4">ID</th>
                                            <th>Партнер</th>
                                            <th>Контакты</th>
                                            <th>Регистрация</th>
                                            <th>Личный объем</th>
                                            <th>Уровень</th>
                                            <th>Рефералов</th>
                                            <th class="pe-4">Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for referral in direct_referrals %}
                                        <tr>
                                            <td class="ps-4 fw-bold">{{ referral.user_id }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm me-3">
                                                        <div class="avatar-title bg-light text-accent rounded-circle">
                                                            {{ referral.first_name|first|upper }}{{ referral.last_name|first|upper }}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div class="fw-medium">{{ referral.get_full_name|default:referral.username }}</div>
                                                        <small class="text-muted">
                                                            {% if referral.user_type == 'store' %}
                                                                <i class="fas fa-store fa-xs me-1"></i>Магазин
                                                            {% else %}
                                                                <i class="fas fa-user fa-xs me-1"></i>Партнер
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if referral.email %}
                                                <div class="small">
                                                    <i class="fas fa-envelope fa-xs me-1 text-muted"></i>
                                                    {{ referral.email|truncatechars:20 }}
                                                </div>
                                                {% endif %}
                                                {% if referral.phone %}
                                                <div class="small">
                                                    <i class="fas fa-phone fa-xs me-1 text-muted"></i>
                                                    {{ referral.phone }}
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="small">{{ referral.date_joined|date:"d.m.Y" }}</div>
                                                <div class="text-muted extra-small">{{ referral.date_joined|timesince }} назад</div>
                                            </td>
                                            <td>
                                                <div class="fw-medium">{{ referral.personal_volume }} бал</div>
                                                <div class="text-muted extra-small">Группа: {{ referral.group_volume }} бал</div>
                                            </td>
                                            <td>
                                                <span class="badge {% if referral.partner_level == 'Начинающий' %}bg-secondary{% else %}bg-accent{% endif %}">
                                                    {{ referral.partner_level }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-users fa-xs text-muted me-2"></i>
                                                    <span class="fw-medium">{{ referral.total_referrals }}</span>
                                                </div>
                                            </td>
                                            <td class="pe-4">
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            data-bs-toggle="tooltip" title="Просмотр деталей"
                                                            onclick="showReferralDetails('{{ referral.user_id }}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary"
                                                            data-bs-toggle="tooltip" title="Написать сообщение">
                                                        <i class="fas fa-envelope"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary"
                                                            data-bs-toggle="tooltip" title="Перейти в структуру"
                                                            onclick="window.location.href='?parent={{ referral.user_id }}'">
                                                        <i class="fas fa-external-link-alt"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center py-5">
                                                <div class="empty-state">
                                                    <div class="empty-icon mb-3">
                                                        <i class="fas fa-users-slash fa-3x text-muted"></i>
                                                    </div>
                                                    <h5 class="text-muted">У вас пока нет рефералов</h5>
                                                    <p class="text-muted mb-4">Приглашайте друзей и партнеров, чтобы построить свою команду!</p>
                                                    <button class="btn btn-gradient" onclick="shareReferralLink()">
                                                        <i class="fas fa-share-alt me-2"></i>Поделиться реферальной ссылкой
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Пагинация -->
                    {% if direct_referrals.has_other_pages %}
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if direct_referrals.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ direct_referrals.previous_page_number }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for i in direct_referrals.paginator.page_range %}
                                {% if direct_referrals.number == i %}
                                <li class="page-item active">
                                    <span class="page-link">{{ i }}</span>
                                </li>
                                {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}

                            {% if direct_referrals.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ direct_referrals.next_page_number }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                </div>
                <!-- /ВКЛАДКА СПИСОК -->


                <!-- ========== ВКЛАДКА: ГРАФ ========== -->
                <div class="tab-pane fade" id="graph-panel" role="tabpanel">

                    <!-- Панель управления графом -->
                    <div class="graph-toolbar d-flex align-items-center gap-2 p-3 border-bottom">
                        <div class="d-flex align-items-center gap-2 me-auto">
                            <button class="btn btn-sm btn-outline-secondary" id="btnZoomIn" title="Приблизить">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="btnZoomOut" title="Отдалить">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="btnFit" title="По размеру экрана">
                                <i class="fas fa-compress-arrows-alt"></i>
                            </button>
                            <div class="vr mx-1"></div>
                            <select class="form-select form-select-sm" id="graphDepth" style="width: auto;">
                                <option value="1">1 уровень</option>
                                <option value="2">2 уровня</option>
                                <option value="3" selected>3 уровня</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center gap-3 text-muted small">
                            <span><span class="legend-dot" style="background: var(--color-accent);"></span> Вы</span>
                            <span><span class="legend-dot" style="background: var(--color-blue);"></span> Активный</span>
                            <span><span class="legend-dot" style="background: #adb5bd;"></span> Неактивный</span>
                        </div>
                    </div>

                    <!-- Контейнер графа -->
                    <div id="graphContainer" style="height: 600px; position: relative;">
                        <!-- Индикатор загрузки (показывается до загрузки данных) -->
                        <div id="graphLoader" class="d-flex flex-column align-items-center justify-content-center h-100">
                            <div class="spinner-border text-accent mb-3" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <p class="text-muted">Загрузка графа структуры...</p>
                        </div>
                        <!-- Сюда Vis.js отрисует граф -->
                        <div id="graphNetwork" style="width:100%; height:100%; display:none;"></div>
                    </div>

                    <!-- Тултип при наведении на узел -->
                    <div id="graphTooltip" class="graph-tooltip shadow-sm" style="display:none;"></div>

                </div>
                <!-- /ВКЛАДКА ГРАФ -->

            </div>
            <!-- /tab-content -->

        </div>
    </div>
</div>

<!-- Модальное окно для деталей реферала -->
<div class="modal fade" id="referralModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детальная информация</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="referralDetails">
                <div class="text-center py-5">
                    <div class="spinner-border text-accent" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3 text-muted">Загрузка данных...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_css %}
<style>
/* ── Общие стили страницы ── */
.avatar-sm { width: 40px; height: 40px; }
.avatar-title {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 600;
}
.extra-small { font-size: 0.75rem; }
.empty-state { max-width: 400px; margin: 0 auto; text-align: center; }
.empty-icon { opacity: 0.5; }
.filter-tabs .btn { margin-right: 8px; margin-bottom: 8px; }
.filter-tabs .btn.active {
    background-color: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
}
.table-hover tbody tr:hover { background-color: rgba(var(--color-accent-rgb), 0.05); }
.btn-group-sm .btn { padding: 0.25rem 0.5rem; }

/* ── Вкладки ── */
.nav-tabs .nav-link { color: var(--color-gray-600); font-weight: 500; }
.nav-tabs .nav-link.active {
    color: var(--color-accent);
    border-bottom-color: white;
}

/* ── Граф ── */
.graph-toolbar { background: #fafafa; }

.legend-dot {
    display: inline-block;
    width: 10px; height: 10px;
    border-radius: 50%;
    margin-right: 4px;
}

#graphContainer {
    background: #f8f9fa;
    border-radius: 0 0 0.375rem 0.375rem;
    overflow: hidden;
}

.graph-tooltip {
    position: fixed;
    z-index: 9999;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 10px 14px;
    min-width: 180px;
    pointer-events: none;
    font-size: 0.85rem;
    line-height: 1.6;
}
.graph-tooltip .tt-name { font-weight: 700; margin-bottom: 4px; }
.graph-tooltip .tt-row  { color: #6c757d; }
.graph-tooltip .tt-badge {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 20px;
    font-size: 0.75rem;
    color: white;
    background: #adb5bd;
}
.graph-tooltip .tt-badge.active { background: var(--color-blue, #0d6efd); }

/* ── Детали реферала (модальное) ── */
#referralDetails .detail-row {
    display: flex; margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color, #dee2e6);
}
#referralDetails .detail-label { font-weight: 600; width: 180px; color: #6c757d; }
#referralDetails .detail-value { flex: 1; }
</style>
{% endblock %}


{% block extra_js %}
<!-- Vis.js Network (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/vis-network.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/dist/vis-network.min.css">

<script>
/* ============================================================
   СПИСОК РЕФЕРАЛОВ — старый код без изменений
   ============================================================ */
document.addEventListener('DOMContentLoaded', function () {

    // Тултипы Bootstrap
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el =>
        new bootstrap.Tooltip(el)
    );

    // Фильтрация по уровню
    document.querySelectorAll('.filter-tabs .btn').forEach(btn => {
        btn.addEventListener('click', function () {
            document.querySelectorAll('.filter-tabs .btn').forEach(b => {
                b.classList.remove('active', 'btn-accent');
                b.classList.add('btn-outline-secondary');
            });
            this.classList.remove('btn-outline-secondary');
            this.classList.add('active', 'btn-accent');
            loadReferralsByLevel(this.dataset.level);
        });
    });

    // Поиск
    let searchTimeout;
    document.getElementById('searchReferrals').addEventListener('input', function (e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => filterTable(e.target.value.toLowerCase()), 300);
    });

    // Ленивая загрузка графа — только когда пользователь открывает вкладку
    document.getElementById('graph-tab').addEventListener('shown.bs.tab', function () {
        initGraph();
    });

    // Смена глубины графа
    document.getElementById('graphDepth').addEventListener('change', function () {
        initGraph(parseInt(this.value));
    });
});


/* ============================================================
   ГРАФ СТРУКТУРЫ
   ============================================================ */
let networkInstance = null;   // глобальная ссылка на граф

/**
 * Загружает данные с сервера и рисует дерево рефералов.
 * @param {number} depth — глубина дерева (1–3)
 */
function initGraph(depth) {
    depth = depth || parseInt(document.getElementById('graphDepth').value) || 3;

    const loader  = document.getElementById('graphLoader');
    const netDiv  = document.getElementById('graphNetwork');

    // Показываем спиннер, скрываем граф
    loader.style.display  = 'flex';
    netDiv.style.display  = 'none';

    // Уничтожаем старый граф (если был)
    if (networkInstance) {
        networkInstance.destroy();
        networkInstance = null;
    }

    fetch(`/cabinet/api/referrals/tree/?depth=${depth}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) throw new Error(data.message);
            renderGraph(data);
        })
        .catch(err => {
            loader.innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>${err.message || 'Не удалось загрузить граф'}</p>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="initGraph()">
                        <i class="fas fa-redo me-1"></i>Попробовать снова
                    </button>
                </div>`;
        });
}

/**
 * Принимает JSON {nodes: [...], edges: [...]} и рисует граф через Vis.js.
 *
 * Ожидаемый формат node:
 * {
 *   id: 1,
 *   label: "Иван И.",        // отображается под узлом
 *   title: "Иван Иванов",   // используется для тултипа (опционально)
 *   level: 0,               // 0 = корень (вы), 1 = прямые рефералы, …
 *   active: true,           // активен ли пользователь
 *   personal_volume: 120,
 *   partner_level: "Партнер",
 *   total_referrals: 5
 * }
 *
 * Ожидаемый формат edge:
 * { from: 0, to: 1 }
 */
function renderGraph(data) {
    const loader = document.getElementById('graphLoader');
    const netDiv = document.getElementById('graphNetwork');

    // --- Цвета ---
    const COLOR_ROOT    = getComputedStyle(document.documentElement)
                            .getPropertyValue('--color-accent').trim() || '#198754';
    const COLOR_ACTIVE  = getComputedStyle(document.documentElement)
                            .getPropertyValue('--color-blue').trim()   || '#0d6efd';
    const COLOR_PASSIVE = '#adb5bd';
    const COLOR_FONT    = '#343a40';

    // --- Подготовка узлов ---
    const nodes = data.nodes.map(n => {
        const isRoot   = n.level === 0;
        const color    = isRoot ? COLOR_ROOT : (n.active ? COLOR_ACTIVE : COLOR_PASSIVE);
        const size     = isRoot ? 36 : Math.max(20, 28 - n.level * 4);

        return {
            id:    n.id,
            label: n.label,
            // Храним оригинальные данные для тултипа
            _data: n,
            shape: 'circularImage',
            // Если нет аватара — рисуем инициалы через canvas data-URL
            image: n.avatar_url || generateAvatar(n.label, color),
            size:  size,
            font: {
                size:  isRoot ? 14 : 12,
                color: COLOR_FONT,
                face:  'system-ui, sans-serif',
            },
            borderWidth: isRoot ? 3 : 2,
            color: {
                border:     color,
                background: color,
                highlight:  { border: color, background: color },
                hover:      { border: color, background: color },
            },
        };
    });

    const edges = data.edges.map(e => ({
        from:   e.from,
        to:     e.to,
        arrows: { to: { enabled: true, scaleFactor: 0.6 } },
        color:  { color: '#dee2e6', highlight: COLOR_ACTIVE, hover: '#adb5bd' },
        width:  1.5,
        smooth: { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.4 },
    }));

    // --- Опции Vis.js ---
    const options = {
        layout: {
            hierarchical: {
                enabled:          true,
                direction:        'UD',        // сверху вниз
                sortMethod:       'directed',
                levelSeparation:  110,
                nodeSpacing:      80,
                treeSpacing:      120,
            },
        },
        physics: { enabled: false },
        interaction: {
            hover:          true,
            tooltipDelay:   0,
            hideEdgesOnDrag: true,
        },
        nodes: {
            borderWidthSelected: 3,
            shapeProperties: { useBorderWithImage: true },
        },
        edges: {
            selectionWidth: 2,
        },
    };

    // --- Рисуем ---
    networkInstance = new vis.Network(
        netDiv,
        { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) },
        options
    );

    // Скрываем лоадер, показываем граф
    networkInstance.once('afterDrawing', () => {
        loader.style.display = 'none';
        netDiv.style.display  = 'block';
    });

    // --- Кнопки управления ---
    document.getElementById('btnZoomIn').onclick  = () => networkInstance.moveTo({ scale: networkInstance.getScale() * 1.3 });
    document.getElementById('btnZoomOut').onclick = () => networkInstance.moveTo({ scale: networkInstance.getScale() * 0.7 });
    document.getElementById('btnFit').onclick     = () => networkInstance.fit({ animation: { duration: 400, easingFunction: 'easeInOutQuad' } });

    // --- Кастомный тултип при наведении ---
    const tooltip = document.getElementById('graphTooltip');

    networkInstance.on('hoverNode', function (params) {
        const nodeId = params.node;
        const nodeData = nodes.find(n => n.id === nodeId)?._data;
        if (!nodeData) return;

        tooltip.innerHTML = buildTooltipHTML(nodeData);
        tooltip.style.display = 'block';
        positionTooltip(params.event);
    });

    networkInstance.on('blurNode', () => {
        tooltip.style.display = 'none';
    });

    document.getElementById('graphNetwork').addEventListener('mousemove', e => {
        if (tooltip.style.display !== 'none') positionTooltip(e);
    });

    // Клик по узлу — открываем детали (кроме корневого)
    networkInstance.on('click', function (params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const nodeData = nodes.find(n => n.id === nodeId)?._data;
            if (nodeData && nodeData.level !== 0) {
                showReferralDetails(nodeId);
            }
        }
    });
}

/** Позиционирует тултип рядом с курсором */
function positionTooltip(e) {
    const tooltip = document.getElementById('graphTooltip');
    const x = (e.clientX || e.pageX) + 14;
    const y = (e.clientY || e.pageY) + 14;

    // Не выходить за правый/нижний край экрана
    const tw = tooltip.offsetWidth;
    const th = tooltip.offsetHeight;
    tooltip.style.left = (x + tw > window.innerWidth  ? x - tw - 28 : x) + 'px';
    tooltip.style.top  = (y + th > window.innerHeight ? y - th - 28 : y) + 'px';
}

/** Создаёт HTML для тултипа узла */
function buildTooltipHTML(n) {
    const isActive = n.active;
    return `
        <div class="tt-name">${n.title || n.label}</div>
        <div class="tt-row"><b>ID:</b> ${n.id}</div>
        ${n.partner_level ? `<div class="tt-row"><b>Уровень:</b> ${n.partner_level}</div>` : ''}
        ${n.personal_volume != null ? `<div class="tt-row"><b>Личный объем:</b> ${n.personal_volume} бал</div>` : ''}
        ${n.total_referrals != null ? `<div class="tt-row"><b>Рефералов:</b> ${n.total_referrals}</div>` : ''}
        <div class="mt-1">
            <span class="tt-badge ${isActive ? 'active' : ''}">
                ${isActive ? 'Активный' : 'Неактивный'}
            </span>
        </div>
    `;
}

/**
 * Генерирует data-URL с аватаром из инициалов (canvas).
 * Используется как fallback, если у пользователя нет фото.
 */
function generateAvatar(label, bgColor) {
    const initials = (label || '?').substring(0, 1).toUpperCase();
    const canvas   = document.createElement('canvas');
    canvas.width   = canvas.height = 64;
    const ctx      = canvas.getContext('2d');

    // Фон
    ctx.fillStyle = bgColor || '#adb5bd';
    ctx.beginPath();
    ctx.arc(32, 32, 32, 0, Math.PI * 2);
    ctx.fill();

    // Инициалы
    ctx.fillStyle   = '#ffffff';
    ctx.font        = 'bold 28px system-ui, sans-serif';
    ctx.textAlign   = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(initials, 32, 33);

    return canvas.toDataURL();
}


/* ============================================================
   КОД ДЛЯ ВКЛАДКИ «СПИСОК» (без изменений относительно оригинала)
   ============================================================ */
function loadReferralsByLevel(level) {
    const tbody = document.querySelector('tbody');
    const oldContent = tbody.innerHTML;

    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-5">
                <div class="spinner-border text-accent" role="status"></div>
                <p class="mt-3 text-muted">Загрузка данных уровня ${level}...</p>
            </td>
        </tr>`;

    fetch(`/cabinet/api/referrals/?level=${level}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) throw new Error(data.message);
            if (!data.referrals.length) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">На этом уровне рефералов нет</h5>
                    </div></td></tr>`;
                return;
            }
            updateTable(data.referrals, level);
        })
        .catch(err => {
            tbody.innerHTML = oldContent;
            showAlert('danger', `Ошибка: ${err.message}`);
        });
}

function updateTable(referrals, level) {
    const tbody = document.querySelector('tbody');
    tbody.innerHTML = referrals.map(r => `
        <tr class="${level > 1 ? `level-${r.level || level}` : ''}">
            <td class="ps-4 fw-bold">${r.id}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-sm me-3">
                        <div class="avatar-title bg-light text-accent rounded-circle">
                            ${(r.name || 'U').charAt(0)}
                        </div>
                    </div>
                    <div>
                        <div class="fw-medium">${r.name || `Пользователь ${r.id}`}</div>
                        <small class="text-muted">${r.level ? `Уровень ${r.level}` : 'Прямой реферал'}</small>
                    </div>
                </div>
            </td>
            <td>
                ${r.email ? `<div class="small"><i class="fas fa-envelope fa-xs me-1 text-muted"></i>${r.email}</div>` : ''}
                ${r.phone ? `<div class="small"><i class="fas fa-phone fa-xs me-1 text-muted"></i>${r.phone}</div>` : ''}
            </td>
            <td>${r.registration_date ? `<div class="small">${r.registration_date}</div>` : '<div class="text-muted">-</div>'}</td>
            <td>
                <div class="fw-medium">${r.personal_volume || 0} бал</div>
                <div class="text-muted extra-small">Группа: ${r.group_volume || 0} бал</div>
            </td>
            <td>
                <span class="badge ${r.partner_level === 'Начинающий' ? 'bg-secondary' : 'bg-accent'}">
                    ${r.partner_level || '-'}
                </span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-users fa-xs text-muted me-2"></i>
                    <span class="fw-medium">${r.team_count || r.total_referrals || 0}</span>
                </div>
            </td>
            <td class="pe-4">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="showReferralDetails('${r.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${r.email ? `<button class="btn btn-outline-secondary" onclick="window.location.href='mailto:${r.email}'">
                        <i class="fas fa-envelope"></i>
                    </button>` : ''}
                </div>
            </td>
        </tr>`).join('');

    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
}

function filterTable(searchTerm) {
    let visible = 0;
    document.querySelectorAll('tbody tr').forEach(row => {
        if (row.querySelector('.empty-state')) return;
        const show = row.textContent.toLowerCase().includes(searchTerm);
        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });

    if (!visible && searchTerm) {
        const row = document.createElement('tr');
        row.id = 'noResultsRow';
        row.innerHTML = `<td colspan="8" class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Ничего не найдено</h5></td>`;
        document.querySelector('tbody').appendChild(row);
    } else {
        document.getElementById('noResultsRow')?.remove();
    }
}

function showReferralDetails(userId) {
    const modal = new bootstrap.Modal(document.getElementById('referralModal'));
    modal.show();

    fetch(`/cabinet/api/referrals/${userId}/details/`)
        .then(r => r.json())
        .then(data => {
            if (data.error) throw new Error(data.message);
            document.getElementById('referralDetails').innerHTML = createReferralDetailsHTML(data);
        })
        .catch(err => {
            document.getElementById('referralDetails').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Ошибка!</strong> Не удалось загрузить данные.<br>${err.message}
                </div>`;
        });
}

function createReferralDetailsHTML(data) {
    return `
        <div class="user-details">
            <div class="text-center mb-4">
                <div class="avatar-lg mx-auto mb-3">
                    <div class="avatar-title bg-light text-accent rounded-circle"
                         style="width:80px;height:80px;font-size:2rem;">
                        ${(data.name || 'U').charAt(0)}
                    </div>
                </div>
                <h4>${data.name || `Пользователь ${data.id}`}</h4>
                <span class="badge ${data.user_type === 'store' ? 'bg-warning' : 'bg-accent'}">
                    ${data.user_type === 'store' ? 'Магазин' : 'Партнер'}
                </span>
            </div>
            <div class="row">
                <div class="col-md-6">
                    ${detailRow('ID', data.id)}
                    ${detailRow('Email', data.email)}
                    ${detailRow('Телефон', data.phone)}
                    ${detailRow('Страна', data.country)}
                </div>
                <div class="col-md-6">
                    ${detailRow('Дата регистрации', data.registration_date)}
                    ${detailRow('Личный объем', data.personal_volume != null ? data.personal_volume + ' бал' : null)}
                    ${detailRow('Групповой объем', data.group_volume != null ? data.group_volume + ' бал' : null)}
                    ${detailRow('Уровень', data.partner_level
                        ? `<span class="badge ${data.partner_level === 'Начинающий' ? 'bg-secondary' : 'bg-accent'}">${data.partner_level}</span>`
                        : null)}
                </div>
            </div>
            <div class="mt-4 pt-3 border-top text-center">
                <div class="row">
                    <div class="col"><div class="h4 mb-1">${data.total_referrals || 0}</div><div class="text-muted small">Рефералов</div></div>
                    <div class="col"><div class="h4 mb-1">${data.active_referrals || 0}</div><div class="text-muted small">Активных</div></div>
                    <div class="col"><div class="h4 mb-1">${data.earnings || 0}</div><div class="text-muted small">Начисления</div></div>
                </div>
            </div>
            ${data.available_for_withdrawal ? `
            <div class="alert alert-success mt-3 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-wallet me-2"></i><strong>Доступно для вывода:</strong></span>
                <span class="h5 mb-0">${data.available_for_withdrawal} сум</span>
            </div>` : ''}
        </div>`;
}

function detailRow(label, value) {
    return `
        <div class="detail-row">
            <div class="detail-label">${label}:</div>
            <div class="detail-value">${value || '<span class="text-muted">Не указано</span>'}</div>
        </div>`;
}

function showAlert(type, message) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alert.innerHTML = `<i class="fas fa-${type === 'danger' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
        ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    const container = document.querySelector('.col-lg-9');
    container.insertBefore(alert, container.firstChild);
    setTimeout(() => alert.parentNode && alert.remove(), 5000);
}

function shareReferralLink() {
    const referralLink = document.getElementById('referralLink')?.value ||
                         '{{ request.scheme }}://{{ request.get_host }}/register/{{ user.referral_link }}/';
    if (navigator.share) {
        navigator.share({ title: 'Присоединяйтесь к EVERON!', url: referralLink });
    } else {
        navigator.clipboard.writeText(referralLink)
            .then(() => showAlert('success', 'Ссылка скопирована!'))
            .catch(() => showAlert('danger', 'Не удалось скопировать ссылку'));
    }
}
</script>

<style>
/* Отступы уровней в списке */
.level-2 td:first-child { padding-left: 50px !important; position: relative; }
.level-2 td:first-child::before { content: "↳"; position: absolute; left: 25px; color: #adb5bd; }
.level-3 td:first-child { padding-left: 70px !important; position: relative; }
.level-3 td:first-child::before { content: "↳"; position: absolute; left: 45px; color: #adb5bd; }
</style>
{% endblock %}
