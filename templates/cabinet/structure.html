{% extends 'base.html' %}
{% load static %}


{% block title %}Моя структура | EVERON{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Боковое меню -->
        <div class="col-lg-3 mb-4">
            {% include 'includes/sidebar.html' %}
        </div>
        
        <!-- Основная информация -->
        <div class="col-lg-9">
            <!-- Заголовок и статистика -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-sitemap me-2"></i> Моя структура</h1>
                <div class="text-end">
                    <div class="text-muted small">ID партнера: {{ user.username }}</div>
                    <div class="text-muted small">Всего рефералов: {{ total_referrals }}</div>
                </div>
            </div>

            <!-- Статистика карточки -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Всего рефералов</div>
                            <div class="stat-value">{{ total_referrals }}</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-users fa-2x" style="color: var(--color-green);"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Активных рефералов</div>
                            <div class="stat-value">{{ active_referrals }}</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-user-check fa-2x" style="color: var(--color-blue);"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="stat-label">Групповой объем</div>
                            <div class="stat-value">{{ group_volume }} бал</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-line fa-2x" style="color: var(--color-orange);"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===================== ВКЛАДКИ ===================== -->
            <ul class="nav nav-tabs mb-0" id="structureTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="tab"
                            data-bs-target="#list-panel" type="button" role="tab"
                            aria-controls="list-panel" aria-selected="true">
                        <i class="fas fa-list me-1"></i> Список
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="graph-tab" data-bs-toggle="tab"
                            data-bs-target="#graph-panel" type="button" role="tab"
                            aria-controls="graph-panel" aria-selected="false">
                        <i class="fas fa-project-diagram me-1"></i> Граф структуры
                    </button>
                </li>
            </ul>

            <div class="tab-content border border-top-0 rounded-bottom bg-white" id="structureTabContent">

                <!-- ========== ВКЛАДКА: СПИСОК ========== -->
                <div class="tab-pane fade show active p-0" id="list-panel" role="tabpanel">

                    <!-- Фильтры и поиск -->
                    <div class="card border-0 border-bottom rounded-0">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="filter-tabs mb-3 mb-md-0">
                                        <button class="btn btn-sm btn-outline-accent active" data-level="1">
                                            1-й уровень <span class="badge bg-accent ms-1">{{ direct_referrals.paginator.count }}</span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" data-level="2">
                                            2-й уровень
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" data-level="3">
                                            3-й уровень
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-sm" 
                                               id="searchReferrals" placeholder="Поиск...">
                                        <button class="btn btn-outline-secondary btn-sm" type="button">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Таблица рефералов -->
                    <div class="card border-0 rounded-0 rounded-bottom">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-4">ID</th>
                                            <th>Партнер</th>
                                            <th>Контакты</th>
                                            <th>Регистрация</th>
                                            <th>Личный объем</th>
                                            <th>Уровень</th>
                                            <th>Рефералов</th>
                                            <th class="pe-4">Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for referral in direct_referrals %}
                                        <tr>
                                            <td class="ps-4 fw-bold">{{ referral.user_id }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm me-3">
                                                        <div class="avatar-title bg-light text-accent rounded-circle">
                                                            {{ referral.first_name|first|upper }}{{ referral.last_name|first|upper }}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div class="fw-medium">{{ referral.get_full_name|default:referral.username }}</div>
                                                        <small class="text-muted">
                                                            {% if referral.user_type == 'store' %}
                                                                <i class="fas fa-store fa-xs me-1"></i>Магазин
                                                            {% else %}
                                                                <i class="fas fa-user fa-xs me-1"></i>Партнер
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if referral.email %}
                                                <div class="small">
                                                    <i class="fas fa-envelope fa-xs me-1 text-muted"></i>
                                                    {{ referral.email|truncatechars:20 }}
                                                </div>
                                                {% endif %}
                                                {% if referral.phone %}
                                                <div class="small">
                                                    <i class="fas fa-phone fa-xs me-1 text-muted"></i>
                                                    {{ referral.phone }}
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="small">{{ referral.date_joined|date:"d.m.Y" }}</div>
                                                <div class="text-muted extra-small">{{ referral.date_joined|timesince }} назад</div>
                                            </td>
                                            <td>
                                                <div class="fw-medium">{{ referral.personal_volume }} бал</div>
                                                <div class="text-muted extra-small">Группа: {{ referral.group_volume }} бал</div>
                                            </td>
                                            <td>
                                                <span class="badge {% if referral.partner_level == 'Начинающий' %}bg-secondary{% else %}bg-accent{% endif %}">
                                                    {{ referral.partner_level }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-users fa-xs text-muted me-2"></i>
                                                    <span class="fw-medium">{{ referral.total_referrals }}</span>
                                                </div>
                                            </td>
                                            <td class="pe-4">
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            data-bs-toggle="tooltip" title="Просмотр деталей"
                                                            onclick="showReferralDetails('{{ referral.user_id }}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary"
                                                            data-bs-toggle="tooltip" title="Написать сообщение">
                                                        <i class="fas fa-envelope"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary"
                                                            data-bs-toggle="tooltip" title="Перейти в структуру"
                                                            onclick="window.location.href='?parent={{ referral.user_id }}'">
                                                        <i class="fas fa-external-link-alt"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center py-5">
                                                <div class="empty-state">
                                                    <div class="empty-icon mb-3">
                                                        <i class="fas fa-users-slash fa-3x text-muted"></i>
                                                    </div>
                                                    <h5 class="text-muted">У вас пока нет рефералов</h5>
                                                    <p class="text-muted mb-4">Приглашайте друзей и партнеров, чтобы построить свою команду!</p>
                                                    <button class="btn btn-gradient" onclick="shareReferralLink()">
                                                        <i class="fas fa-share-alt me-2"></i>Поделиться реферальной ссылкой
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Пагинация -->
                    {% if direct_referrals.has_other_pages %}
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if direct_referrals.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ direct_referrals.previous_page_number }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            {% for i in direct_referrals.paginator.page_range %}
                                {% if direct_referrals.number == i %}
                                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                                {% else %}
                                <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                                {% endif %}
                            {% endfor %}
                            {% if direct_referrals.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ direct_referrals.next_page_number }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                </div>
                <!-- /ВКЛАДКА СПИСОК -->


                <!-- ========== ВКЛАДКА: ГРАФ ========== -->
                <div class="tab-pane fade" id="graph-panel" role="tabpanel">

                    <!-- Панель управления графом -->
                    <div class="graph-toolbar d-flex align-items-center gap-2 p-3 border-bottom"
                         style="background:#0d0f14; border-color:#2a2d38 !important;">

                        <div class="d-flex align-items-center gap-2 me-auto">
                            <button class="btn btn-sm btn-dark border-secondary" id="btnZoomIn" title="Приблизить">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-dark border-secondary" id="btnZoomOut" title="Отдалить">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="btn btn-sm btn-dark border-secondary" id="btnFit" title="По размеру экрана">
                                <i class="fas fa-compress-arrows-alt"></i>
                            </button>
                        </div>

                        <!-- Легенда -->
                        <div class="d-flex align-items-center gap-3 small">
                            <span style="color:#64748b;">
                                <span class="tree-legend-dot" style="background:#3a4060;"></span> LO &lt; 100
                            </span>
                            <span style="color:#64748b;">
                                <span class="tree-legend-dot" style="background:#2563eb;"></span> LO 100–499
                            </span>
                            <span style="color:#64748b;">
                                <span class="tree-legend-dot" style="background:#16a34a;"></span> LO 500–999
                            </span>
                            <span style="color:#64748b;">
                                <span class="tree-legend-dot" style="background:#d97706;"></span> LO 1000+
                            </span>
                        </div>
                    </div>

                    <!-- Контейнер графа — тёмный фон -->
                    <div id="graphContainer"
                         style="height:600px; overflow:auto; background:#0d0f14; position:relative; border-radius:0 0 0.375rem 0.375rem;">

                        <!-- Loader -->
                        <div id="graphLoader"
                             style="display:flex; flex-direction:column; align-items:center;
                                    justify-content:center; height:100%; gap:16px;">
                            <div style="width:40px;height:40px;border:3px solid #2a2d38;
                                        border-top-color:#4f9cf9;border-radius:50%;
                                        animation:treeSpinner 0.8s linear infinite;"></div>
                            <p style="color:#64748b; font-family:'JetBrains Mono',monospace;
                                      font-size:12px; margin:0;">Загрузка структуры...</p>
                        </div>

                        <!-- SVG граф -->
                        <svg id="graphSVG" style="display:none; font-family:'JetBrains Mono',monospace;"></svg>
                    </div>

                    <!-- Тултип -->
                    <div id="graphTooltip"></div>

                </div>
                <!-- /ВКЛАДКА ГРАФ -->

            </div>
            <!-- /tab-content -->

        </div>
    </div>
</div>

<!-- Модальное окно для деталей реферала -->
<div class="modal fade" id="referralModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детальная информация</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="referralDetails">
                <div class="text-center py-5">
                    <div class="spinner-border text-accent" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3 text-muted">Загрузка данных...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_css %}
<style>
/* ── Общие стили страницы ── */
.avatar-sm { width: 40px; height: 40px; }
.avatar-title {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 600;
}
.extra-small { font-size: 0.75rem; }
.empty-state { max-width: 400px; margin: 0 auto; text-align: center; }
.empty-icon { opacity: 0.5; }
.filter-tabs .btn { margin-right: 8px; margin-bottom: 8px; }
.filter-tabs .btn.active {
    background-color: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
}
.table-hover tbody tr:hover { background-color: rgba(var(--color-accent-rgb), 0.05); }
.btn-group-sm .btn { padding: 0.25rem 0.5rem; }

/* ── Вкладки ── */
.nav-tabs .nav-link { color: var(--color-gray-600); font-weight: 500; }
.nav-tabs .nav-link.active {
    color: var(--color-accent);
    border-bottom-color: white;
}

/* ── Граф — тёмная тема ── */
@keyframes treeSpinner { to { transform: rotate(360deg); } }

.tree-legend-dot {
    display: inline-block;
    width: 10px; height: 10px;
    border-radius: 2px;
    margin-right: 4px;
    vertical-align: middle;
}

/* Тултип */
#graphTooltip {
    position: fixed;
    z-index: 9999;
    background: #1e2433;
    border: 1px solid #2a2d38;
    border-radius: 10px;
    padding: 14px 16px;
    min-width: 210px;
    pointer-events: none;
    display: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    font-size: 12px;
    font-family: 'Manrope', system-ui, sans-serif;
    color: #e2e8f0;
}
#graphTooltip .tt-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: #4f9cf9;
    margin-bottom: 10px;
    border-bottom: 1px solid #2a2d38;
    padding-bottom: 8px;
}
#graphTooltip .tt-row {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin: 4px 0;
}
#graphTooltip .tt-label { color: #64748b; font-size: 11px; }
#graphTooltip .tt-val {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    font-size: 11px;
}
#graphTooltip .tt-qual {
    text-align: center;
    margin-top: 8px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    background: rgba(79,156,249,0.15);
    color: #4f9cf9;
}

/* ── Детали реферала (модальное) ── */
#referralDetails .detail-row {
    display: flex; margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color, #dee2e6);
}
#referralDetails .detail-label { font-weight: 600; width: 180px; color: #6c757d; }
#referralDetails .detail-value { flex: 1; }

/* Уровни в таблице */
.level-2 td:first-child { padding-left: 50px !important; position: relative; }
.level-2 td:first-child::before { content: "↳"; position: absolute; left: 25px; color: #adb5bd; }
.level-3 td:first-child { padding-left: 70px !important; position: relative; }
.level-3 td:first-child::before { content: "↳"; position: absolute; left: 45px; color: #adb5bd; }
</style>
{% endblock %}


{% block extra_js %}
<script>
/* ============================================================
   СПИСОК РЕФЕРАЛОВ
   ============================================================ */
document.addEventListener('DOMContentLoaded', function () {

    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el =>
        new bootstrap.Tooltip(el)
    );

    document.querySelectorAll('.filter-tabs .btn').forEach(btn => {
        btn.addEventListener('click', function () {
            document.querySelectorAll('.filter-tabs .btn').forEach(b => {
                b.classList.remove('active', 'btn-accent');
                b.classList.add('btn-outline-secondary');
            });
            this.classList.remove('btn-outline-secondary');
            this.classList.add('active', 'btn-accent');
            loadReferralsByLevel(this.dataset.level);
        });
    });

    let searchTimeout;
    document.getElementById('searchReferrals').addEventListener('input', function (e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => filterTable(e.target.value.toLowerCase()), 300);
    });

    // Ленивая загрузка графа при открытии вкладки
    document.getElementById('graph-tab').addEventListener('shown.bs.tab', function () {
        initGraph();
    });
});


/* ============================================================
   ГРАФ — тёмная тема, один запрос, работаем только с деревом
   ============================================================ */

const CARD_W = 110;
const CARD_H = 68;
const GAP_Y  = 110;

let graphLoaded = false;

/* ── SVG helper ── */
function svgEl(tag, attrs) {
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    Object.entries(attrs).forEach(([k, v]) => el.setAttribute(k, v));
    return el;
}

/* ── Цветовая схема по LO ── */
function loStyle(lo) {
    if (lo >= 1000) return { fill: '#2a1e06', stroke: '#d97706', textColor: '#fbbf24' };
    if (lo >= 500)  return { fill: '#0b1f12', stroke: '#16a34a', textColor: '#4ade80' };
    if (lo >= 100)  return { fill: '#0c1829', stroke: '#2563eb', textColor: '#60a5fa' };
    return              { fill: '#14182a', stroke: '#3a4060', textColor: '#94a3b8' };
}

/* ── Строим дерево из nodes + edges (оба id приводим к строке) ── */
function buildTree(nodes, edges) {
    const map = {};
    nodes.forEach(n => { map[String(n.id)] = { ...n, id: String(n.id), _children: [] }; });

    const childIds = new Set();
    edges.forEach(e => {
        const from = String(e.from), to = String(e.to);
        if (map[from] && map[to]) {
            map[from]._children.push(map[to]);
            childIds.add(to);
        }
    });

    const rootNode = nodes.find(n => !childIds.has(String(n.id)));
    return rootNode ? map[String(rootNode.id)] : null;
}

/* ── Считаем листья ── */
function countLeaves(node) {
    if (!node._children || node._children.length === 0) return 1;
    return node._children.reduce((s, c) => s + countLeaves(c), 0);
}

/* ── Layout — рекурсивно, всё хранится прямо в узлах дерева ── */
function layoutTree(node, state) {
    node._y = state.startY + (node.level || 0) * (CARD_H + GAP_Y);

    if (!node._children || node._children.length === 0) {
        state.cursor += state.gapX;
        node._x = state.cursor;
        return;
    }
    node._children.forEach(c => layoutTree(c, state));
    node._x = (node._children[0]._x + node._children[node._children.length - 1]._x) / 2;
}

/* ── Рисуем рёбра рекурсивно по дереву ── */
function drawLinks(node, container) {
    (node._children || []).forEach(child => {
        const x1 = node._x,  y1 = node._y  + CARD_H / 2;
        const x2 = child._x, y2 = child._y - CARD_H / 2;
        const my = (y1 + y2) / 2;

        container.appendChild(svgEl('path', {
            d: `M${x1},${y1} C${x1},${my} ${x2},${my} ${x2},${y2}`,
            fill: 'none',
            stroke: '#2a2d38',
            'stroke-width': '1.5'
        }));
        drawLinks(child, container);
    });
}

/* ── Рисуем узлы рекурсивно по дереву ── */
function drawNodes(node, container) {
    const lo   = node.personal_volume || 0;
    const go   = node.group_volume    || 0;
    const qual = node.partner_level   || '';
    const st   = loStyle(lo);
    const cx   = node._x, cy = node._y;
    const bx   = cx - CARD_W / 2, by = cy - CARD_H / 2;

    const g = svgEl('g', { style: 'cursor:pointer;' });

    const rect = svgEl('rect', {
        x: bx, y: by, width: CARD_W, height: CARD_H,
        rx: 8, ry: 8, fill: st.fill, stroke: st.stroke, 'stroke-width': '1.5'
    });
    const accentBar = svgEl('rect', {
        x: bx + 1, y: by + 1, width: CARD_W - 2, height: 3,
        rx: 7, fill: st.stroke
    });

    // #ID
    const tId = svgEl('text', { x: cx, y: cy - 20, 'text-anchor': 'middle',
        fill: '#e2e8f0', 'font-size': '11', 'font-weight': '700',
        'font-family': 'JetBrains Mono, monospace' });
    tId.textContent = `#${node.id}`;

    // Квалификация
    const tQual = svgEl('text', { x: cx, y: cy - 5, 'text-anchor': 'middle',
        fill: '#94a3b8', 'font-size': '9', 'font-weight': '600',
        'font-family': 'system-ui, sans-serif', 'letter-spacing': '0.04em' });
    tQual.textContent = qual.toUpperCase();

    // LO
    const tLoL = svgEl('text', { x: cx - 22, y: cy + 14, 'text-anchor': 'middle', fill: '#64748b', 'font-size': '8', 'font-family': 'system-ui' });
    tLoL.textContent = 'LO';
    const tLoV = svgEl('text', { x: cx - 22, y: cy + 25, 'text-anchor': 'middle', fill: st.textColor, 'font-size': '10', 'font-weight': '700', 'font-family': 'JetBrains Mono, monospace' });
    tLoV.textContent = lo;

    // Разделитель
    const divLine = svgEl('line', { x1: cx, y1: cy + 8, x2: cx, y2: cy + 28, stroke: '#2a2d38', 'stroke-width': '1' });

    // GO
    const tGoL = svgEl('text', { x: cx + 22, y: cy + 14, 'text-anchor': 'middle', fill: '#64748b', 'font-size': '8', 'font-family': 'system-ui' });
    tGoL.textContent = 'GO';
    const tGoV = svgEl('text', { x: cx + 22, y: cy + 25, 'text-anchor': 'middle', fill: '#a78bfa', 'font-size': '10', 'font-weight': '700', 'font-family': 'JetBrains Mono, monospace' });
    tGoV.textContent = go;

    g.append(rect, accentBar, tId, tQual, tLoL, tLoV, divLine, tGoL, tGoV);

    g.addEventListener('mouseenter', e => { rect.style.opacity = '0.85'; showGraphTooltip(e, node); });
    g.addEventListener('mousemove',  moveGraphTooltip);
    g.addEventListener('mouseleave', ()  => { rect.style.opacity = '1';   hideGraphTooltip(); });
    if ((node.level || 0) > 0) {
        g.addEventListener('click', () => showReferralDetails(node.id));
    }

    container.appendChild(g);
    (node._children || []).forEach(c => drawNodes(c, container));
}

/* ── Главная функция инициализации ── */
function initGraph() {
    if (graphLoaded) return;

    const loader = document.getElementById('graphLoader');
    const svg    = document.getElementById('graphSVG');
    loader.style.display = 'flex';
    svg.style.display    = 'none';

    fetch('/cabinet/api/referrals/tree/')
        .then(r => r.json())
        .then(data => {
            // Данных нет или пустые
            if (!data.nodes || data.nodes.length === 0) {
                throw new Error('Структура пуста');
            }

            const root = buildTree(data.nodes, data.edges || []);
            if (!root) throw new Error('Не удалось построить дерево');

            // Размеры холста
            const leaves = countLeaves(root);
            const maxLvl = Math.max(...data.nodes.map(n => n.level || 0));
            const gapX   = 130;
            const totalW = Math.max(900,  (leaves + 1) * gapX);
            const totalH = Math.max(400,  (maxLvl + 2) * (CARD_H + GAP_Y));

            // Раскладываем
            layoutTree(root, { cursor: 0, gapX: totalW / (leaves + 1), startY: 50 });

            // Рисуем
            svg.setAttribute('width',   totalW);
            svg.setAttribute('height',  totalH);
            svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);
            svg.style.background = '#0d0f14';
            svg.innerHTML = '';

            const linksG = svgEl('g', {});
            drawLinks(root, linksG);
            svg.appendChild(linksG);

            const nodesG = svgEl('g', {});
            drawNodes(root, nodesG);
            svg.appendChild(nodesG);

            loader.style.display = 'none';
            svg.style.display    = 'block';
            graphLoaded = true;

            // Зум
            let scale = 1;
            document.getElementById('btnZoomIn').onclick = () => {
                scale = Math.min(scale * 1.25, 4);
                svg.style.transform = `scale(${scale})`;
                svg.style.transformOrigin = 'top left';
            };
            document.getElementById('btnZoomOut').onclick = () => {
                scale = Math.max(scale * 0.8, 0.25);
                svg.style.transform = `scale(${scale})`;
                svg.style.transformOrigin = 'top left';
            };
            document.getElementById('btnFit').onclick = () => {
                scale = 1;
                svg.style.transform = '';
                document.getElementById('graphContainer').scrollTo(0, 0);
            };
        })
        .catch(err => {
            loader.innerHTML = `
                <div style="text-align:center;">
                    <i class="fas fa-exclamation-triangle fa-2x" style="color:#ef4444; margin-bottom:10px;"></i>
                    <p style="color:#94a3b8; margin:8px 0;">${err.message || 'Не удалось загрузить граф'}</p>
                    <button class="btn btn-sm btn-dark border-secondary mt-2"
                            onclick="graphLoaded=false; initGraph()">
                        <i class="fas fa-redo me-1"></i>Попробовать снова
                    </button>
                </div>`;
        });
}

/* ── Тултип ── */
const graphTooltip = document.getElementById('graphTooltip');

function showGraphTooltip(e, n) {
    const fmt = v => (v === undefined || v === null || v === '') ? '—' : v;
    graphTooltip.innerHTML = `
        <div class="tt-title">Пользователь #${n.id}</div>
        <div class="tt-row"><span class="tt-label">Имя</span><span class="tt-val">${fmt(n.title || n.label)}</span></div>
        <div class="tt-row"><span class="tt-label">LO (личный объём)</span><span class="tt-val">${fmt(n.personal_volume)}</span></div>
        <div class="tt-row"><span class="tt-label">GO (групповой объём)</span><span class="tt-val">${fmt(n.group_volume)}</span></div>
        <div class="tt-row"><span class="tt-label">Рефералов</span><span class="tt-val">${fmt(n.total_referrals)}</span></div>
        <div class="tt-row"><span class="tt-label">Статус</span><span class="tt-val">${n.active ? '✅ Активный' : '⚪ Неактивный'}</span></div>
        ${n.partner_level ? `<div class="tt-qual">${n.partner_level}</div>` : ''}
    `;
    graphTooltip.style.display = 'block';
    moveGraphTooltip(e);
}

function moveGraphTooltip(e) {
    const pad = 14;
    let x = e.clientX + pad;
    let y = e.clientY + pad;
    const tw = graphTooltip.offsetWidth;
    const th = graphTooltip.offsetHeight;
    if (x + tw > window.innerWidth  - 8) x = e.clientX - tw - pad;
    if (y + th > window.innerHeight - 8) y = e.clientY - th - pad;
    graphTooltip.style.left = x + 'px';
    graphTooltip.style.top  = y + 'px';
}

function hideGraphTooltip() {
    graphTooltip.style.display = 'none';
}


/* ============================================================
   СПИСОК РЕФЕРАЛОВ
   ============================================================ */
function loadReferralsByLevel(level) {
    const tbody = document.querySelector('tbody');
    const oldContent = tbody.innerHTML;

    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-5">
                <div class="spinner-border text-accent" role="status"></div>
                <p class="mt-3 text-muted">Загрузка данных уровня ${level}...</p>
            </td>
        </tr>`;

    fetch(`/cabinet/api/referrals/?level=${level}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) throw new Error(data.message);
            if (!data.referrals.length) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">На этом уровне рефералов нет</h5>
                    </div></td></tr>`;
                return;
            }
            updateTable(data.referrals, level);
        })
        .catch(err => {
            tbody.innerHTML = oldContent;
            showAlert('danger', `Ошибка: ${err.message}`);
        });
}

function updateTable(referrals, level) {
    const tbody = document.querySelector('tbody');
    tbody.innerHTML = referrals.map(r => `
        <tr class="${level > 1 ? `level-${r.level || level}` : ''}">
            <td class="ps-4 fw-bold">${r.id}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-sm me-3">
                        <div class="avatar-title bg-light text-accent rounded-circle">
                            ${(r.name || 'U').charAt(0)}
                        </div>
                    </div>
                    <div>
                        <div class="fw-medium">${r.name || `Пользователь ${r.id}`}</div>
                        <small class="text-muted">${r.level ? `Уровень ${r.level}` : 'Прямой реферал'}</small>
                    </div>
                </div>
            </td>
            <td>
                ${r.email ? `<div class="small"><i class="fas fa-envelope fa-xs me-1 text-muted"></i>${r.email}</div>` : ''}
                ${r.phone ? `<div class="small"><i class="fas fa-phone fa-xs me-1 text-muted"></i>${r.phone}</div>` : ''}
            </td>
            <td>${r.registration_date ? `<div class="small">${r.registration_date}</div>` : '<div class="text-muted">-</div>'}</td>
            <td>
                <div class="fw-medium">${r.personal_volume || 0} бал</div>
                <div class="text-muted extra-small">Группа: ${r.group_volume || 0} бал</div>
            </td>
            <td>
                <span class="badge ${r.partner_level === 'Начинающий' ? 'bg-secondary' : 'bg-accent'}">
                    ${r.partner_level || '-'}
                </span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-users fa-xs text-muted me-2"></i>
                    <span class="fw-medium">${r.team_count || r.total_referrals || 0}</span>
                </div>
            </td>
            <td class="pe-4">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="showReferralDetails('${r.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${r.email ? `<button class="btn btn-outline-secondary" onclick="window.location.href='mailto:${r.email}'">
                        <i class="fas fa-envelope"></i>
                    </button>` : ''}
                </div>
            </td>
        </tr>`).join('');

    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
}

function filterTable(searchTerm) {
    let visible = 0;
    document.querySelectorAll('tbody tr').forEach(row => {
        if (row.querySelector('.empty-state')) return;
        const show = row.textContent.toLowerCase().includes(searchTerm);
        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    if (!visible && searchTerm) {
        const row = document.createElement('tr');
        row.id = 'noResultsRow';
        row.innerHTML = `<td colspan="8" class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Ничего не найдено</h5></td>`;
        document.querySelector('tbody').appendChild(row);
    } else {
        document.getElementById('noResultsRow')?.remove();
    }
}

function showReferralDetails(userId) {
    const modal = new bootstrap.Modal(document.getElementById('referralModal'));
    modal.show();

    fetch(`/cabinet/api/referrals/${userId}/details/`)
        .then(r => r.json())
        .then(data => {
            if (data.error) throw new Error(data.message);
            document.getElementById('referralDetails').innerHTML = createReferralDetailsHTML(data);
        })
        .catch(err => {
            document.getElementById('referralDetails').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Ошибка!</strong> Не удалось загрузить данные.<br>${err.message}
                </div>`;
        });
}

function createReferralDetailsHTML(data) {
    return `
        <div class="user-details">
            <div class="text-center mb-4">
                <div class="avatar-lg mx-auto mb-3">
                    <div class="avatar-title bg-light text-accent rounded-circle"
                         style="width:80px;height:80px;font-size:2rem;">
                        ${(data.name || 'U').charAt(0)}
                    </div>
                </div>
                <h4>${data.name || `Пользователь ${data.id}`}</h4>
                <span class="badge ${data.user_type === 'store' ? 'bg-warning' : 'bg-accent'}">
                    ${data.user_type === 'store' ? 'Магазин' : 'Партнер'}
                </span>
            </div>
            <div class="row">
                <div class="col-md-6">
                    ${detailRow('ID', data.id)}
                    ${detailRow('Email', data.email)}
                    ${detailRow('Телефон', data.phone)}
                    ${detailRow('Страна', data.country)}
                </div>
                <div class="col-md-6">
                    ${detailRow('Дата регистрации', data.registration_date)}
                    ${detailRow('Личный объем', data.personal_volume != null ? data.personal_volume + ' бал' : null)}
                    ${detailRow('Групповой объем', data.group_volume != null ? data.group_volume + ' бал' : null)}
                    ${detailRow('Уровень', data.partner_level
                        ? `<span class="badge ${data.partner_level === 'Начинающий' ? 'bg-secondary' : 'bg-accent'}">${data.partner_level}</span>`
                        : null)}
                </div>
            </div>
            <div class="mt-4 pt-3 border-top text-center">
                <div class="row">
                    <div class="col"><div class="h4 mb-1">${data.total_referrals || 0}</div><div class="text-muted small">Рефералов</div></div>
                    <div class="col"><div class="h4 mb-1">${data.active_referrals || 0}</div><div class="text-muted small">Активных</div></div>
                    <div class="col"><div class="h4 mb-1">${data.earnings || 0}</div><div class="text-muted small">Начисления</div></div>
                </div>
            </div>
            ${data.available_for_withdrawal ? `
            <div class="alert alert-success mt-3 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-wallet me-2"></i><strong>Доступно для вывода:</strong></span>
                <span class="h5 mb-0">${data.available_for_withdrawal} сум</span>
            </div>` : ''}
        </div>`;
}

function detailRow(label, value) {
    return `
        <div class="detail-row">
            <div class="detail-label">${label}:</div>
            <div class="detail-value">${value || '<span class="text-muted">Не указано</span>'}</div>
        </div>`;
}

function showAlert(type, message) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alert.innerHTML = `<i class="fas fa-${type === 'danger' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
        ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    const container = document.querySelector('.col-lg-9');
    container.insertBefore(alert, container.firstChild);
    setTimeout(() => alert.parentNode && alert.remove(), 5000);
}

function shareReferralLink() {
    const referralLink = document.getElementById('referralLink')?.value ||
                         '{{ request.scheme }}://{{ request.get_host }}/register/{{ user.referral_link }}/';
    if (navigator.share) {
        navigator.share({ title: 'Присоединяйтесь к EVERON!', url: referralLink });
    } else {
        navigator.clipboard.writeText(referralLink)
            .then(() => showAlert('success', 'Ссылка скопирована!'))
            .catch(() => showAlert('danger', 'Не удалось скопировать ссылку'));
    }
}
</script>
{% endblock %}