{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Боковое меню -->
        <div class="col-lg-3 mb-4">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="user-info">
                        <div class="user-avatar">
                            {% if user.first_name %}
                                {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                            {% else %}
                                {{ user.username|first|upper }}
                            {% endif %}
                        </div>
                        <div>
                            <div class="user-name">
                                {{ user.get_full_name|default:user.username }}
                            </div>
                            <div class="user-status">Партнер</div>
                            <span class="status-badge">{{ user.partner_level }}</span>
                        </div>
                    </div>
                </div>

                <ul class="sidebar-menu">
                    <li><a href="{% url 'cabinet:dashboard' %}" class="active">
                        <i class="fas fa-tachometer-alt"></i> Главная ЛК</a>
                    </li>
                    <li><a href="#"><i class="fas fa-link"></i> Реферальная ссылка</a></li>
                    <li><a href="#"><i class="fas fa-user-plus"></i> Регистрация пользователя</a></li>
                    <li><a href="#"><i class="fas fa-sitemap"></i> Моя структура</a></li>
<!--                    <li><a href="{% url 'cabinet:purchases' %}">-->
                    <li><a href="#">
                        <i class="fas fa-shopping-bag"></i> Мои покупки</a>
                    </li>
                    <li><a href="#"><i class="fas fa-newspaper"></i> Новости компании</a></li>
                    <li><a href="#"><i class="fas fa-wallet"></i> Финансы</a></li>
<!--                    <li><a href="{% url 'cabinet:finance' %}"><i class="fas fa-wallet"></i> Финансы</a></li>-->
                    <li><a href="#"><i class="fas fa-cog"></i> Настройки</a></li>
<!--                    <li><a href="{% url 'cabinet:profile' %}"><i class="fas fa-cog"></i> Настройки</a></li>-->
                </ul>
            </div>
        </div>

        <!-- Основная информация -->
        <div class="col-lg-9">
            <!-- Приветствие -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Личный кабинет</h1>
                <div class="text-end">
                    <div class="text-muted small">ID партнера: {{ user.username }}</div>
                    <div class="text-muted small">Дата регистрации: {{ user.registration_date|date:"d.m.Y" }}</div>
                </div>
            </div>

            <!-- Статистика -->
            <div class="stats-grid" id="stats-container">
    <div class="stat-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="stat-label">Личный объем</div>
                <div class="stat-value" id="personal-volume">
                    {% if has_stats %}
                        {{ user_stats.lo|floatformat:0 }} сум
                    {% else %}
                        <span class="text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Загрузка...
                        </span>
                    {% endif %}
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up me-1"></i> +{{ monthly_growth }}% за месяц
                </div>
            </div>
            <div class="stat-icon">
                <i class="fas fa-chart-line fa-2x" style="color: var(--color-red);"></i>
            </div>
        </div>
        <div class="mt-3">
            <div class="d-flex justify-content-between mb-1">
                <small>Квалификация</small>
                <small id="qualification">
                    {% if has_stats %}
                        {{ user_stats.qualification|default:"-" }}
                    {% else %}
                        -
                    {% endif %}
                </small>
            </div>
            <div class="progress-custom">
                <div class="progress-bar-custom" style="width: {{ progress_to_next_level }}%"></div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="stat-label">Групповой объем</div>
                <div class="stat-value" id="group-volume">
                    {% if has_stats %}
                        {{ user_stats.go|floatformat:0 }} сум
                    {% else %}
                        <span class="text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Загрузка...
                        </span>
                    {% endif %}
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up me-1"></i> +{{ group_growth }}% за месяц
                </div>
            </div>
            <div class="stat-icon">
                <i class="fas fa-users fa-2x" style="color: var(--color-orange);"></i>
            </div>
        </div>
        <div class="mt-3">
            <div class="d-flex justify-content-between align-items-center">
                <small>Баллы</small>
                <span class="badge bg-gradient" id="points">
                    {% if has_stats %}
                        {{ user_stats.points|floatformat:0 }}
                    {% else %}
                        0
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="stat-label">Начисления</div>
                <div class="stat-value" id="total-income">
                    {% if has_stats %}
                        {{ user_stats.total_income|floatformat:0 }} сум
                    {% else %}
                        <span class="text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Загрузка...
                        </span>
                    {% endif %}
                </div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up me-1"></i> +{{ earnings_growth }}% за месяц
                </div>
            </div>
            <div class="stat-icon">
                <i class="fas fa-wallet fa-2x" style="color: var(--color-orange);"></i>
            </div>
        </div>
        <div class="mt-3">
            <div class="d-flex justify-content-between align-items-center">
                <small>Доступно для вывода</small>
                <span class="badge bg-success" id="personal-money">
                    {% if has_stats %}
                        {{ user_stats.personal_money|floatformat:0 }} сум
                    {% else %}
                        0
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Кнопка обновления -->
<div class="text-end mt-3">
    <button class="btn btn-sm btn-outline-primary" id="refresh-stats-btn">
        <i class="fas fa-sync-alt me-1"></i> Обновить данные
    </button>
    <small class="text-muted ms-2" id="last-updated">
        {% if has_stats %}Данные актуальны{% else %}Обновление...{% endif %}
    </small>
</div>

            <!-- Быстрые действия -->
            <div class="actions-grid mb-4">
                <div class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <h4>Реферальная ссылка</h4>
                    <p class="text-muted small mb-3">Приглашайте новых партнеров по вашей уникальной ссылке</p>
                    <!-- В разделе "Реферальная ссылка" обновите: -->
<div class="input-group mb-3">
    <input type="text" class="form-control"
           value="{{ request.scheme }}://{{ request.get_host }}/register/{{ user.referral_link }}/"
           readonly id="referralLink">
    <button class="btn btn-gradient" type="button" onclick="copyReferralLink()">
        <i class="fas fa-copy"></i>
    </button>
</div>

<!-- Добавьте кнопку для генерации новой ссылки: -->
<div class="mt-3 text-center">
    <a href="{% url 'accounts:generate_new_link' %}" class="btn btn-outline-accent btn-sm">
        <i class="fas fa-sync-alt me-1"></i>Сгенерировать новую ссылку
    </a>
    <div class="form-text small mt-1">
        После генерации старая ссылка перестанет работать
    </div>
</div>
                </div>

                <div class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h4>Регистрация партнера</h4>
                    <p class="text-muted small mb-3">Зарегистрируйте нового пользователя в вашей структуре</p>
                    <button class="btn btn-gradient w-100 mb-2" data-bs-toggle="modal" data-bs-target="#registerModal">
                        <i class="fas fa-user-plus me-2"></i>Зарегистрировать
                    </button>
                    <div class="text-center small text-muted">
                        <i class="fas fa-info-circle me-1"></i> Требуется подтверждение
                    </div>
                </div>
            </div>

            <!-- Финансы -->
            <div class="earnings-card mb-4">
                <div class="earnings-header">
                    <div>
                        <h3 class="mb-1">Финансовые начисления</h3>
                        <p class="text-muted small mb-0">История начислений за последний месяц</p>
                    </div>
                    <div class="text-end">
                        <div class="h4 mb-1" style="color: var(--color-red);">+{{ user.earnings|floatformat:0 }} сум</div>
                        <div class="text-success small">
                            <i class="fas fa-arrow-up me-1"></i> +8.7% к прошлому месяцу
                        </div>
                    </div>
                </div>

                <div class="earnings-chart">
                    <div class="text-center">
                        <i class="fas fa-chart-bar fa-3x mb-3" style="color: var(--color-gray-300);"></i>
                        <p>График начислений за месяц</p>
                        <small class="text-muted">(здесь будет интерактивный график)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно регистрации -->
<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Регистрация нового партнера</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="mb-3">
                        <label class="form-label">Имя и фамилия</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Телефон</label>
                        <input type="tel" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Страна</label>
                        <select class="form-select" required>
                            <option value="">Выберите страну</option>
                            <option value="RU">Россия</option>
                            <option value="KZ">Казахстан</option>
                            <option value="BY">Беларусь</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Пароль</label>
                        <input type="password" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-accent" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" form="registerForm" class="btn btn-gradient">
                    <i class="fas fa-user-plus me-2"></i>Зарегистрировать
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refresh-stats-btn');
    const lastUpdated = document.getElementById('last-updated');

    // Функция обновления данных
    function refreshStats(showNotification = true) {
        if (showNotification) {
            lastUpdated.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обновление...';
        }

        fetch('api/get-stats/')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateUI(data.data);
                    lastUpdated.innerHTML = '<i class="fas fa-check text-success"></i> Данные обновлены';

                    if (showNotification) {
                        showToast('Данные успешно обновлены', 'success');
                    }
                } else {
                    lastUpdated.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Ошибка обновления';
                    if (showNotification) {
                        showToast('Не удалось обновить данные', 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                lastUpdated.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Ошибка сети';
                if (showNotification) {
                    showToast('Ошибка сети', 'error');
                }
            });
    }

    // Функция обновления UI
    function updateUI(stats) {
        // Форматирование чисел с пробелами
        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(num));
        }

        // Обновляем значения
        document.getElementById('personal-volume').textContent = formatNumber(stats.lo) + ' сум';
        document.getElementById('group-volume').textContent = formatNumber(stats.go) + ' сум';
        document.getElementById('total-income').textContent = formatNumber(stats.total_income) + ' сум';
        document.getElementById('personal-money').textContent = formatNumber(stats.personal_money) + ' сум';
        document.getElementById('qualification').textContent = stats.qualification || '-';
        document.getElementById('points').textContent = formatNumber(stats.points);
    }

    // Функция показа уведомлений
    function showToast(message, type = 'info') {
        // Используйте свою систему уведомлений или toastr.js
        console.log(`${type}: ${message}`);
    }

    // Обработчик кнопки обновления
    refreshBtn.addEventListener('click', function() {
        refreshStats(true);
    });

    // Автоматическое обновление каждые 2 минуты
    setInterval(() => refreshStats(false), 120000);

    // Первое обновление через 10 секунд после загрузки страницы
    setTimeout(() => refreshStats(false), 10000);
});
</script>
{% endblock %}